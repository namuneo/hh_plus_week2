# 🛒 이커머스 핵심 기능 요구사항 분석 (SKU 제거·단순화 버전, 연동 제외)

## 1. 상품 관리 (Product 단위 재고)
- **상품 등록/수정 (운영자)**
  - 기본 정보: 이름, 설명, 브랜드, 카테고리, 이미지, 노출 여부
  - 가격, 재고(`stock_qty`), 안전재고 설정/수정
  - 품절/비노출 설정
- **상품 조회 (고객)**
  - 목록: 카테고리/검색/정렬(인기·최신·가격)
  - 상세: 가격, 재고, 이미지, 설명
- **재고 실시간 확인**
  - 장바구니/결제 단계 가용 재고 확인
  - 결제 승인 시 **원자적 재고 차감**(낙관적 락 `version`)
- **재고 조정 (운영자)**
  - 입고/반품/조정 등 증감 처리, 조정 이력(전/후 수량, 사유, 담당자)
- **인기 상품 통계**
  - 최근 3일 매출/판매량 Top 5 집계(요약 테이블/캐시, 5분 단위 갱신)

---

## 2. 주문/결제
- **장바구니**
  - 회원/비회원 지원(guest 토큰), 상품/수량/가격 스냅샷 저장
  - 수량 변경/삭제, 결제 시점 가격 변동 재계산
- **주문 생성**
  - 장바구니 → 주문(PENDING) 전환
  - 재고/쿠폰 유효성 검증, 주문 TTL 내 미결제 시 자동 만료(EXPIRED)
- **결제(내부 지갑 가정)**
  - 잔액 확인 → 결제 금액 차감 → 재고 차감(조건 업데이트)
  - 성공: 주문 상태 PAID, 실패: 롤백(잔액/재고 복구)
  - **Idempotency-Key**로 중복 결제 방지
- **주문 조회**
  - 내 주문 목록/상세, 결제 상태·금액·쿠폰 적용 내역
- **주문 이력**
  - 상태 전이 로그(PENDING→PAID/EXPIRED/CANCELLED)

---

## 3. 쿠폰
- **쿠폰 정책(운영자)**
  - 코드, 유형(정액/정율), 금액, 총 발급수량, 유효기간
  - 1인당 발급/사용 제한, 최소결제금액, 적용 대상(상품/카테고리)
  - 상태: DRAFT→PUBLISHED→PAUSED→EXPIRED
- **선착순 발급(고객)**
  - 총 발급수량 한도 내 선착순, `UNIQUE(couponId,userId)`로 중복 방지
  - 동시성 하에서 정확한 수량 제어(원자적 증가)
- **유효성 검증/사용 이력**
  - 결제 전 쿠폰 상태·기간·최소금액·대상 검증
  - 발급/사용 시각, 주문ID, 할인금액 기록
  - 주문 취소 시 쿠폰 복구 정책(옵션)

---

## 4. 비기능 요구
- **동시성/무결성**: 재고 차감 시 조건 업데이트(`stock_qty >= 주문수량 AND version 일치`)
- **오류 처리**: 재고 부족(409), 잔액 부족(402), 쿠폰 무효(422) 명확화
- **로그/감사**: 주문 상태 이력, 재고 조정 이력 필수

---