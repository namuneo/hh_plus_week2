# 🛒 이커머스 핵심 기능 요구사항 분석

## 1. 상품 관리
- **상품 등록/수정 (운영자)**
    - 상품 기본 정보(이름, 설명, 브랜드, 카테고리, 이미지, 노출 여부) 등록
    - SKU(색상, 사이즈 등 옵션) 단위 가격·재고·안전재고 등록
    - 상품 비노출/품절 설정 및 수정 가능

- **상품 정보 조회 (고객)**
    - 상품 목록 조회 (카테고리, 검색, 정렬: 인기순/최신순/가격순)
    - 상품 상세 조회 (SKU 단위 가격, 재고, 이미지, 상세 설명)

- **재고 실시간 확인**
    - 장바구니/결제 단계에서 SKU별 가용재고 확인
    - 주문 시점 재고 차감

- **재고 조정 (운영자)**
    - 재고 증감 처리(입고, 조정, 반품 등)
    - 조정 이력 기록 (조정 전/후 수량, 담당자, 사유)

- **인기 상품 통계**
    - 최근 3일 기준 매출/판매량 Top 5 집계

---

## 2. 주문/결제 시스템
- **장바구니 기능**
    - 회원/비회원 장바구니 관리 (cartId 기반)
    - SKU, 수량, 가격 스냅샷 저장
    - 수량 변경, 삭제, 옵션 변경 가능

- **주문 생성**
    - 장바구니 → 주문 대기 상태로 전환
    - 재고·가격·쿠폰 유효성 검증 후 결제 준비
    - 유효시간 내 결제 미완료 시 주문 자동 취소

- **재고 확인 및 차감**
    - 결제 승인 시 SKU별 원자적 재고 차감 
    - 재고 부족 시 결제 실패 및 롤백

- **잔액 기반 결제**
    - 사용자의 내부 지갑 잔액에서 결제 금액 차감
    - 결제 성공 시 주문상태 = 결제완료
    - 실패 시 잔액 복구 및 주문 취소 처리
    - Idempotency-Key 기반 중복 결제 방지

- **쿠폰 할인 적용**
    - 주문 또는 상품 단위로 1개 쿠폰 적용 가능
    - 할인 계산 순서: 상품할인 → 쿠폰 → 배송비
    - 할인액 및 최종 결제 금액 자동 계산

- **주문 내역 조회**
    - 고객의 주문 목록 및 주문 상세 조회
    - 결제 상태, 금액, 쿠폰 적용 내역 표시

---

## 3. 쿠폰 시스템
- **쿠폰 등록/관리 (운영자)**
    - 쿠폰 코드, 할인유형(정액/정율), 할인금액, 총 발급수량 등록
    - 유효기간, 1인당 발급/사용 제한, 최소결제금액 설정
    - 적용 대상 상품/카테고리 설정
    - 상태 전이: 초안(DRAFT) → 공개(PUBLISHED) → 중지(PAUSED) → 만료(EXPIRED)

- **선착순 발급 (고객)**
    - 쿠폰 총 발급수량 내에서 선착순 발급
    - 중복 발급 방지 (userId + couponId unique)
    - 동시 요청에도 정확한 수량 제어(원자적 카운터)

- **쿠폰 유효성 검증**
    - 결제 시 쿠폰의 상태, 기간, 최소금액, 대상상품 검증
    - 만료·중지 상태 쿠폰은 자동 비활성화

- **사용 이력 관리**
    - 쿠폰 발급 및 사용 시각, 주문ID, 할인금액 기록
    - 주문 취소 시 쿠폰 복구 정책 선택적 적용

---

## 4. 데이터 연동
- **주문 데이터 외부 전송**
    - 결제 완료(`ORDER_PAID`) 이벤트 발생 시 Outbox 테이블 적재
    - 별도 워커/배치가 외부 데이터 플랫폼에 전송
    - 재시도 및 DLQ(Dead Letter Queue) 지원

- **전송 실패 시 처리**
    - 주문 성공과 데이터 전송은 분리 (비동기 보장)
    - 외부 전송 실패 시 주문 상태는 정상 유지
    - 재시도 또는 수동 재전송 가능

- **데이터 보안 및 일관성**
    - 개인정보 마스킹 (주소, 전화번호 등)
    - 이벤트 스키마 버전 관리
    - 외부 수신 측 중복 수신 대비 (Idempotent event_id)

---

## 5. 추가 기능 요약
- 사용자 인증 및 지갑 잔액 관리
- 판매/전환 통계 집계
- 감사 로그(Audit Log) 저장
- 장애 및 재시도 모니터링 시스템

---